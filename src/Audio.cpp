#include "Audio.hpp"
#include <Arduino.h>

const std::array<uint32_t, 12> noteFreqs = { 262, 277, 294, 311, 330, 349, 367, 392, 415, 440, 466, 494 };

const std::array<std::string, 12> noteNames = { "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B" };

const std::array<int16_t, 256> sineTable = { 0, 803, 1607, 2410, 3211, 4010, 4807, 5601, 6392, 7178, 7961, 8739, 9511,
    10278, 11038, 11792, 12539, 13278, 14009, 14732, 15445, 16150, 16845, 17530, 18204, 18867, 19519, 20159, 20786,
    21402, 22004, 22594, 23169, 23731, 24278, 24811, 25329, 25831, 26318, 26789, 27244, 27683, 28105, 28510, 28897,
    29268, 29620, 29955, 30272, 30571, 30851, 31113, 31356, 31580, 31784, 31970, 32137, 32284, 32412, 32520, 32609,
    32678, 32727, 32757, 32767, 32757, 32727, 32678, 32609, 32520, 32412, 32284, 32137, 31970, 31784, 31580, 31356,
    31113, 30851, 30571, 30272, 29955, 29620, 29268, 28897, 28510, 28105, 27683, 27244, 26789, 26318, 25831, 25329,
    24811, 24278, 23731, 23169, 22594, 22004, 21402, 20786, 20159, 19519, 18867, 18204, 17530, 16845, 16150, 15445,
    14732, 14009, 13278, 12539, 11792, 11038, 10278, 9511, 8739, 7961, 7178, 6392, 5601, 4807, 4010, 3211, 2410, 1607,
    803, 0, -804, -1608, -2411, -3212, -4011, -4808, -5602, -6393, -7179, -7962, -8740, -9512, -10279, -11039, -11793,
    -12540, -13279, -14010, -14733, -15446, -16151, -16846, -17531, -18205, -18868, -19520, -20160, -20787, -21403,
    -22005, -22595, -23170, -23732, -24279, -24812, -25330, -25832, -26319, -26790, -27245, -27684, -28106, -28511,
    -28898, -29269, -29621, -29956, -30273, -30572, -30852, -31114, -31357, -31581, -31785, -31971, -32138, -32285,
    -32413, -32521, -32610, -32679, -32728, -32758, -32768, -32758, -32728, -32679, -32610, -32521, -32413, -32285,
    -32138, -31971, -31785, -31581, -31357, -31114, -30852, -30572, -30273, -29956, -29621, -29269, -28898, -28511,
    -28106, -27684, -27245, -26790, -26319, -25832, -25330, -24812, -24279, -23732, -23170, -22595, -22005, -21403,
    -20787, -20160, -19520, -18868, -18205, -17531, -16846, -16151, -15446, -14733, -14010, -13279, -12540, -11793,
    -11039, -10279, -9512, -8740, -7962, -7179, -6393, -5602, -4808, -4011, -3212, -2411, -1608, -804 };

const std::unordered_map<WaveformName, std::function<int16_t(uint32_t)>> WaveformGenerators = {
    { WaveformName::SAWTOOTH,
        [](uint32_t phase) {
            return INT16_MIN + (phase >> 16);
        } },
    { WaveformName::TRIANGLE,
        [](uint32_t phase) {
            if (phase < 0x80000000) {
                return INT16_MIN + ((phase >> 15) & 0xFFFF);
            } else {
                return INT16_MAX - ((phase >> 15) & 0xFFFF);
            }
        } },
    { WaveformName::SQUARE,
        [](uint32_t phase) {
            return (phase < 0x80000000) ? INT16_MIN : INT16_MAX;
        } },
    { WaveformName::SINE,
        [](uint32_t phase) {
            uint8_t idxWhole = phase >> 24;
            uint16_t idxFrac = (phase & 0x00FFFFFF) >> 8;
            uint16_t idxFracOther = 0xFFFF - idxFrac;

            int16_t prevSample = sineTable[idxWhole];
            int16_t nextSample = sineTable[(idxWhole + 1) % sineTable.size()];

            return (prevSample * idxFracOther + nextSample * idxFrac) / 65536;
        } }
};
